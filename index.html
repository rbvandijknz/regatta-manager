<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regatta Manager</title>
    
    <!-- App Icon (Podium) for Browser Tabs & Home Screen -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23eab308' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 21v-8h6v-3h6v5h6v6H3z' /></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23eab308' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M3 21v-8h6v-3h6v5h6v6H3z' /></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for cleanliness */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Select Styling for Weather Widget */
        select.weather-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
            text-align: center;
            text-align-last: center;
        }
        select.weather-select::-ms-expand { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans pb-20">

    <!-- Sticky Header -->
    <div class="sticky top-0 z-50 bg-slate-900 text-white shadow-lg border-b border-slate-700">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                
                <!-- Brand -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <!-- Custom Podium Icon (SVG) -->
                        <svg class="text-yellow-500 w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 21v-8h6v-3h6v5h6v6H3z" />
                        </svg>
                        <h1 class="text-xl font-bold tracking-tight">RegattaMaster</h1>
                        <!-- Group Indicator -->
                        <span id="group-badge" class="hidden text-xs bg-blue-600 text-white px-2 py-0.5 rounded-full font-mono ml-2 border border-blue-400"></span>
                        
                        <button id="connection-btn" class="ml-2 p-1 rounded hover:bg-slate-800 transition-colors" title="Connection Status">
                            <i id="connection-icon" data-lucide="cloud-off" class="w-5 h-5 text-red-400"></i>
                        </button>
                    </div>
                    <!-- Mobile Clock -->
                    <div class="md:hidden font-mono text-xl text-blue-300 clock-display">00:00</div>
                </div>

                <div class="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
                    <!-- Weather Widget -->
                    <div id="weather-widget" class="flex items-center gap-3 bg-slate-800/80 p-2 rounded-lg border border-slate-700 text-slate-300 text-sm w-full sm:w-auto justify-center">
                        <div class="flex items-center gap-1 relative group cursor-pointer">
                            <i data-lucide="map-pin" class="w-3 h-3 text-slate-500"></i>
                            <!-- Location Selector -->
                            <select id="weather-location" class="weather-select bg-transparent font-semibold text-xs uppercase tracking-wider text-slate-300 focus:text-white focus:outline-none cursor-pointer border-b border-transparent hover:border-slate-500 transition-colors">
                                <option value="karapiro" class="bg-slate-800 text-slate-300">Karapiro</option>
                                <option value="bluelake" class="bg-slate-800 text-slate-300">Blue Lake</option>
                                <option value="ruataniwha" class="bg-slate-800 text-slate-300">Ruataniwha</option>
                            </select>
                        </div>
                        <div class="h-4 w-px bg-slate-600"></div>
                        <div class="flex items-center gap-1">
                            <i id="weather-icon" data-lucide="cloud" class="w-4 h-4 text-blue-300"></i>
                            <span id="weather-temp" class="font-mono font-bold text-white">--°</span>
                        </div>
                        <div class="h-4 w-px bg-slate-600"></div>
                        <div class="flex items-center gap-1">
                            <i data-lucide="wind" class="w-4 h-4 text-slate-400"></i>
                            <span id="weather-wind" class="font-mono">--</span>
                        </div>
                    </div>

                    <!-- Delay Controls -->
                    <div class="flex items-center justify-center gap-4 bg-slate-800 p-2 rounded-lg border border-slate-700 w-full sm:w-auto">
                        <div class="text-xs uppercase text-slate-400 font-semibold tracking-wider mr-2">Delay</div>
                        <button id="btn-delay-minus" class="p-2 hover:bg-slate-700 rounded text-slate-300 active:scale-95 transition" title="Remove 5 mins">
                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                        </button>
                        
                        <div id="delay-display" class="px-4 py-1 rounded font-mono text-xl font-bold text-slate-200 transition-colors">
                            +0m
                        </div>

                        <button id="btn-delay-plus" class="p-2 hover:bg-slate-700 rounded text-yellow-400 active:scale-95 transition" title="Add 5 mins">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Desktop Clock -->
                <div class="hidden md:block font-mono text-2xl text-blue-300 font-semibold w-28 text-right clock-display">
                    00:00
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 py-6 space-y-6">

        <!-- Controls Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            
            <!-- Add Event Form -->
            <form id="add-event-form" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col gap-3">
                <h3 class="font-semibold text-slate-700 flex items-center gap-2">
                    <i data-lucide="play-circle" class="w-4 h-4"></i> Add Event
                </h3>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="input-event-num" placeholder="Ev #" class="w-full sm:w-16 p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                    <input type="text" id="input-alpha" placeholder="Alpha" class="w-full sm:w-16 p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="text" id="input-crew" placeholder="Crew Name" class="w-full sm:flex-1 p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                    <input type="time" id="input-time" class="w-full sm:w-auto p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" required>
                </div>
                <button type="submit" id="btn-submit" disabled class="bg-blue-600 text-white py-2 rounded font-medium hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    Connecting...
                </button>
            </form>

            <!-- Tools Panel -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-slate-700 flex items-center gap-2">
                        <i data-lucide="settings" class="w-4 h-4"></i> Tools
                    </h3>
                    <button type="button" id="btn-toggle-config" class="text-sm text-blue-600 hover:underline">Config</button>
                </div>

                <!-- Hidden Config -->
                <div id="config-panel" class="hidden mb-4 space-y-4 border-b border-slate-100 pb-4">
                    
                    <!-- Shared Access Code -->
                    <div class="bg-blue-50 p-3 rounded border border-blue-100">
                        <div class="text-xs font-bold text-blue-700 uppercase mb-1">Shared Regatta Code</div>
                        <div class="flex gap-2">
                            <input type="text" id="input-group-code" placeholder="e.g. baycoast" class="flex-1 p-1 text-sm border rounded">
                            <button id="btn-join-group" class="bg-blue-600 text-white text-xs px-3 rounded font-medium hover:bg-blue-700">Join</button>
                        </div>
                        <p class="text-[10px] text-blue-500 mt-1">Enter a code to share this schedule with others.</p>
                    </div>

                    <div class="p-3 bg-slate-50 rounded text-sm space-y-2 border border-slate-100">
                        <div class="flex justify-between items-center">
                            <span>On Water Minutes Before:</span>
                            <input type="number" id="input-offset" value="35" class="w-16 p-1 border rounded text-center">
                        </div>
                        <div class="flex justify-between items-center">
                            <span>Warm Up Duration (mins):</span>
                            <input type="number" id="input-warmup" value="40" class="w-16 p-1 border rounded text-center">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mt-2">
                    <label class="flex items-center justify-center gap-2 bg-blue-50 hover:bg-blue-100 text-blue-700 py-2 rounded cursor-pointer transition text-sm font-medium border border-blue-200">
                        <i data-lucide="upload" class="w-4 h-4"></i> Upload CSV
                        <input type="file" id="input-csv" accept=".csv" class="hidden">
                    </label>
                    
                    <button id="btn-template" class="flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 py-2 rounded text-sm font-medium transition border border-slate-200">
                        <i data-lucide="download" class="w-4 h-4"></i> Get Template
                    </button>

                    <button id="btn-demo" class="flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 py-2 rounded text-sm font-medium transition border border-slate-200">
                        Demo Data
                    </button>

                    <button id="btn-clear" class="flex items-center justify-center gap-2 bg-red-50 hover:bg-red-100 text-red-600 rounded transition border border-red-100" title="Clear All">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- List Header -->
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl font-bold text-slate-800">Race Programme</h2>
            <div class="text-sm text-slate-500" id="status-summary">Loading...</div>
        </div>

        <!-- Table Header (Desktop) -->
        <div class="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider">
            <div class="col-span-1">#</div>
            <div class="col-span-1">Alpha</div>
            <div class="col-span-3">Crew</div>
            <div class="col-span-2 text-center">Warm Up</div>
            <div class="col-span-2 text-center text-blue-600">On Water</div>
            <div class="col-span-2 text-right">Start Time</div>
            <div class="col-span-1"></div>
        </div>

        <!-- Events Container -->
        <div id="events-container" class="space-y-3 pb-10"></div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20 bg-white rounded-xl border-2 border-dashed border-slate-200 text-slate-400">
            <i data-lucide="timer" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
            <p class="text-lg font-medium">No events scheduled</p>
            <p class="text-sm">Add manually or upload a CSV.</p>
        </div>

    </div>

    <!-- Firebase & Application Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, setDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAbQE9pdiPYP1BdUb4T6AaEnMQwmfe2s3k",
            authDomain: "regatta-manager-d6101.firebaseapp.com",
            projectId: "regatta-manager-d6101",
            storageBucket: "regatta-manager-d6101.firebasestorage.app",
            messagingSenderId: "1023336958830",
            appId: "1:1023336958830:web:19f0cfc62274189d8b8f7f",
            measurementId: "G-0Y0FELH6KE"
        };
        
        const appId = 'regatta-manager-d6101';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Locations Data ---
        const LOCATIONS = {
            karapiro: { name: 'Karapiro', lat: -37.9265, lon: 175.5435 },
            bluelake: { name: 'Blue Lake', lat: -38.196, lon: 176.327 },
            ruataniwha: { name: 'Ruataniwha', lat: -44.218, lon: 170.086 }
        };

        // --- State ---
        let state = {
            user: null,
            events: [],
            delay: 0,
            settings: { onWaterOffset: 35, warmUpDuration: 40 },
            currentTime: new Date(),
            groupCode: localStorage.getItem('regatta_group_code') || '',
            weather: { temp: null, wind: null, dir: null, code: null },
            locationKey: localStorage.getItem('regatta_location') || 'karapiro'
        };

        // --- DOM Elements ---
        const els = {
            eventsContainer: document.getElementById('events-container'),
            emptyState: document.getElementById('empty-state'),
            delayDisplay: document.getElementById('delay-display'),
            statusSummary: document.getElementById('status-summary'),
            connectionBtn: document.getElementById('connection-btn'),
            submitBtn: document.getElementById('btn-submit'),
            configPanel: document.getElementById('config-panel'),
            clockDisplays: document.querySelectorAll('.clock-display'),
            groupBadge: document.getElementById('group-badge'),
            groupInput: document.getElementById('input-group-code'),
            weatherWidget: {
                select: document.getElementById('weather-location'),
                temp: document.getElementById('weather-temp'),
                wind: document.getElementById('weather-wind'),
                icon: document.getElementById('weather-icon')
            }
        };

        // --- Database Path Helpers ---
        const getEventsRef = () => {
            if (state.groupCode) {
                return collection(db, 'artifacts', appId, 'public', 'data', `${state.groupCode}_events`);
            } else {
                return collection(db, 'artifacts', appId, 'users', state.user.uid, 'regatta_events');
            }
        };

        const getConfigRef = () => {
            if (state.groupCode) {
                return doc(db, 'artifacts', appId, 'public', 'data', `${state.groupCode}_config`, 'main');
            } else {
                return doc(db, 'artifacts', appId, 'users', state.user.uid, 'config', 'main');
            }
        };

        // --- Weather Service ---
        const fetchWeather = async () => {
            try {
                const loc = LOCATIONS[state.locationKey] || LOCATIONS['karapiro'];
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current=temperature_2m,wind_speed_10m,wind_direction_10m,weather_code&wind_speed_unit=kmh&timezone=Pacific%2FAuckland`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.current) {
                    state.weather = {
                        temp: Math.round(data.current.temperature_2m),
                        wind: Math.round(data.current.wind_speed_10m),
                        dir: getWindDir(data.current.wind_direction_10m),
                        code: data.current.weather_code
                    };
                    renderWeather();
                }
            } catch (error) {
                console.error("Weather fetch failed:", error);
                els.weatherWidget.temp.textContent = "--";
            }
        };

        const getWindDir = (d) => {
            const dirs = ['N','NE','E','SE','S','SW','W','NW'];
            return dirs[Math.round(d / 45) % 8];
        };

        const getWeatherIconName = (code) => {
            if (code <= 1) return 'sun';
            if (code <= 3) return 'cloud';
            if (code <= 48) return 'cloud-fog';
            if (code <= 67) return 'cloud-rain';
            if (code <= 77) return 'snowflake';
            if (code <= 82) return 'cloud-rain';
            return 'cloud-lightning';
        };

        const renderWeather = () => {
            if(state.weather.temp !== null) {
                els.weatherWidget.temp.textContent = `${state.weather.temp}°`;
                els.weatherWidget.wind.textContent = `${state.weather.wind}kmh ${state.weather.dir}`;
                const iconName = getWeatherIconName(state.weather.code);
                els.weatherWidget.icon.setAttribute('data-lucide', iconName);
                lucide.createIcons();
            }
            // Ensure select value matches state
            els.weatherWidget.select.value = state.locationKey;
        };

        // --- Rendering & Logic ---
        const timeToMinutes = (str) => { if(!str) return 0; const [h, m] = str.split(':').map(Number); return h * 60 + m; };
        const minutesToTime = (total) => { let m = total % 60; let h = Math.floor(total / 60); if (h >= 24) h %= 24; if (h < 0) h = 24 + (h % 24); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; };
        const formatDisplayTime = (mins) => {
            let h = Math.floor(mins / 60); let m = mins % 60; let ampm = 'AM';
            if (h >= 12) { ampm = 'PM'; if (h > 12) h -= 12; }
            if (h === 0) h = 12; if (h >= 24) h %= 24; 
            return `${h}:${String(m).padStart(2,'0')} ${ampm}`;
        };

        function render() {
            // Update Clocks
            const timeStr = state.currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            els.clockDisplays.forEach(el => el.textContent = timeStr);

            // Update Group Badge
            if(state.groupCode) {
                els.groupBadge.textContent = state.groupCode;
                els.groupBadge.classList.remove('hidden');
            } else {
                els.groupBadge.classList.add('hidden');
            }

            // Update Delay Display
            els.delayDisplay.textContent = `+${state.delay}m`;
            els.delayDisplay.className = state.delay > 0 
                ? "px-4 py-1 rounded font-mono text-xl font-bold bg-red-500/20 text-red-600 border border-red-500/50 transition-colors"
                : "px-4 py-1 rounded font-mono text-xl font-bold text-slate-200 transition-colors";

            // Update Summary
            els.statusSummary.textContent = `${state.events.length} Events | ${state.delay > 0 ? `Delayed ${state.delay}m` : 'On Time'}`;

            // Render Events
            if (state.events.length === 0) {
                els.eventsContainer.innerHTML = '';
                els.emptyState.classList.remove('hidden');
            } else {
                els.emptyState.classList.add('hidden');
                
                const currentMins = timeToMinutes(`${state.currentTime.getHours()}:${state.currentTime.getMinutes()}`);
                const sortedEvents = [...state.events].sort((a,b) => timeToMinutes(a.originalTime) - timeToMinutes(b.originalTime));
                const processedIds = new Set();
                const container = els.eventsContainer;

                sortedEvents.forEach((ev, index) => {
                    processedIds.add(ev.id);
                    const baseMins = timeToMinutes(ev.originalTime);
                    const delayedMins = baseMins + state.delay;
                    const onWaterMins = delayedMins - state.settings.onWaterOffset;
                    const warmUpStartMins = onWaterMins - state.settings.warmUpDuration;

                    const isActive = currentMins >= warmUpStartMins;
                    const isPast = currentMins > delayedMins;
                    const showOriginal = state.delay > 0 && !isPast;
                    
                    let statusClass = 'bg-white shadow-sm border-slate-200';
                    if (isPast) statusClass = 'bg-slate-50 border-slate-200 opacity-60 grayscale';
                    else if (isActive) statusClass = 'bg-white ring-2 ring-blue-400 shadow-md transform scale-[1.01]';

                    let el = document.getElementById(ev.id);
                    
                    if (!el) {
                        el = document.createElement('div');
                        el.id = ev.id;
                        el.innerHTML = `
                            <div class="indicator-bar absolute left-0 top-0 bottom-0 w-1 bg-blue-500 hidden"></div>
                            <div class="p-4 grid grid-cols-2 md:grid-cols-12 gap-4 items-center">
                                
                                <!-- Event # -->
                                <div class="col-span-1 md:col-span-1 hidden md:block">
                                    <div class="bg-slate-100 text-slate-600 font-bold px-1 py-1 rounded text-sm text-center">#${ev.eventNum}</div>
                                </div>

                                <!-- Alpha -->
                                <div class="col-span-1 md:col-span-1 hidden md:block text-center">
                                    <div class="text-slate-500 font-mono font-bold text-sm">${ev.alpha || ''}</div>
                                </div>

                                <!-- Crew (Mobile combines #, Alpha, Crew) -->
                                <div class="col-span-2 md:col-span-3 flex items-start gap-3 md:block">
                                    <div class="md:hidden bg-slate-100 text-slate-600 font-bold px-2 py-1 rounded text-sm min-w-[3rem] text-center">#${ev.eventNum}</div>
                                    <div class="md:hidden bg-slate-50 text-slate-500 border border-slate-200 px-2 py-1 rounded text-sm font-mono font-bold ${!ev.alpha ? 'hidden' : ''}">${ev.alpha || ''}</div>
                                    <div>
                                        <div class="font-bold text-slate-800 text-lg md:text-base leading-tight">${ev.crew}</div>
                                        <div class="original-time text-xs text-red-500 font-medium mt-1 hidden">Original: ${ev.originalTime}</div>
                                    </div>
                                </div>

                                <div class="col-span-1 md:col-span-2 flex flex-col md:items-center">
                                    <span class="md:hidden text-xs text-slate-400 uppercase font-bold mb-1">Begin Warm Up</span>
                                    <div class="val-warmup text-slate-600 font-mono text-sm"></div>
                                </div>
                                <div class="col-span-1 md:col-span-2 flex flex-col md:items-center">
                                    <span class="md:hidden text-xs text-blue-400 uppercase font-bold mb-1">On Water By</span>
                                    <div class="val-onwater text-blue-700 font-bold font-mono text-lg md:text-xl"></div>
                                    <div class="text-[10px] text-slate-400 hidden md:block">-${state.settings.onWaterOffset} min</div>
                                </div>
                                <div class="col-span-2 md:col-span-2 flex flex-row md:flex-col justify-between md:items-end items-center border-t md:border-t-0 pt-3 md:pt-0 mt-2 md:mt-0">
                                    <span class="md:hidden text-sm font-bold text-slate-700">Race Start</span>
                                    <div class="val-start text-xl font-bold font-mono text-slate-800"></div>
                                </div>
                                <div class="col-span-2 md:col-span-1 flex justify-end">
                                    <button onclick="window.deleteEvent('${ev.id}')" class="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded transition">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        el.className = `relative overflow-hidden rounded-xl border transition-all duration-300 fade-in ${statusClass}`;
                    }
                    
                    const baseClasses = "relative overflow-hidden rounded-xl border transition-all duration-300";
                    const targetClass = `${baseClasses} ${statusClass}`;
                    if (!el.className.includes(statusClass)) el.className = targetClass;

                    const updateText = (sel, txt) => { const n = el.querySelector(sel); if(n && n.textContent !== txt) n.textContent = txt; };
                    updateText('.val-warmup', formatDisplayTime(warmUpStartMins));
                    updateText('.val-onwater', formatDisplayTime(onWaterMins));
                    updateText('.val-start', formatDisplayTime(delayedMins));

                    const toggle = (sel, condition) => {
                        const n = el.querySelector(sel);
                        if(n) { if(condition && n.classList.contains('hidden')) n.classList.remove('hidden'); else if(!condition && !n.classList.contains('hidden')) n.classList.add('hidden'); }
                    };
                    toggle('.indicator-bar', isActive);
                    toggle('.original-time', showOriginal);

                    const startNode = el.querySelector('.val-start');
                    if(startNode) {
                        if(state.delay > 0) {
                            if(!startNode.classList.contains('text-red-600')) { startNode.classList.remove('text-slate-800'); startNode.classList.add('text-red-600'); }
                        } else {
                            if(!startNode.classList.contains('text-slate-800')) { startNode.classList.remove('text-red-600'); startNode.classList.add('text-slate-800'); }
                        }
                    }

                    const currentChildAtIndex = container.children[index];
                    if (currentChildAtIndex !== el) {
                        if (currentChildAtIndex) container.insertBefore(el, currentChildAtIndex);
                        else container.appendChild(el);
                    }
                });

                [...container.children].forEach(child => { if (!processedIds.has(child.id)) child.remove(); });
                lucide.createIcons();
            }
        }

        // --- Auth & Setup ---
        const initAuth = async () => { try { await signInAnonymously(auth); } catch(e) { console.error("Auth Error:", e); return e; } };
        initAuth();

        els.connectionBtn.onclick = async () => {
            const currentIcon = els.connectionBtn.querySelector('svg') || els.connectionBtn.querySelector('i');

            if (!state.user) {
                if(currentIcon) currentIcon.classList.add('animate-spin');
                if(confirm("Database is disconnected. Attempt to reconnect?")) {
                    const error = await initAuth();
                    if(currentIcon) currentIcon.classList.remove('animate-spin');
                    if(!auth.currentUser) {
                        const errKey = error?.code || 'unknown';
                        alert(`Connection Failed (${errKey}).\n\nTroubleshooting:\n1. Check internet.\n2. GitHub Pages? Add domain to Firebase Console > Auth > Settings > Authorized Domains.`);
                    }
                } else {
                     if(currentIcon) currentIcon.classList.remove('animate-spin');
                }
            } else {
                alert(`✅ Connected to Database\nProject: ${firebaseConfig.projectId}\nUser ID: ${state.user.uid}`);
            }
        };

        let unsubscribeEvents = null;
        let unsubscribeConfig = null;

        onAuthStateChanged(auth, (u) => {
            state.user = u;
            if(u) {
                els.submitBtn.textContent = "Add to Schedule";
                els.submitBtn.disabled = false;
                els.connectionBtn.innerHTML = '<i data-lucide="cloud" class="w-5 h-5 text-green-400"></i>';
                lucide.createIcons();
                if(state.groupCode) els.groupInput.value = state.groupCode;
                setupListeners();
                
                // Initialize Weather and Location
                els.weatherWidget.select.value = state.locationKey;
                fetchWeather();
                setInterval(fetchWeather, 900000); 

            } else {
                els.connectionBtn.innerHTML = '<i data-lucide="cloud-off" class="w-5 h-5 text-red-400"></i>';
                lucide.createIcons();
            }
        });

        function setupListeners() {
            if (unsubscribeEvents) unsubscribeEvents();
            if (unsubscribeConfig) unsubscribeConfig();
            state.events = [];
            render();

            const eventsRef = getEventsRef();
            const configRef = getConfigRef();

            unsubscribeEvents = onSnapshot(eventsRef, (snap) => {
                state.events = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });

            unsubscribeConfig = onSnapshot(configRef, (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    if(d.delay !== undefined) state.delay = d.delay;
                    if(d.settings) state.settings = d.settings;
                    
                    document.getElementById('input-offset').value = state.settings.onWaterOffset;
                    document.getElementById('input-warmup').value = state.settings.warmUpDuration;
                    render();
                } else {
                    state.delay = 0;
                    render();
                }
            });
        }

        // --- Interaction ---

        // Weather Location Change
        els.weatherWidget.select.onchange = (e) => {
            const newLoc = e.target.value;
            state.locationKey = newLoc;
            localStorage.setItem('regatta_location', newLoc);
            // Reset weather display to loading state briefly
            els.weatherWidget.temp.textContent = "--";
            fetchWeather();
        };

        document.getElementById('btn-join-group').onclick = () => {
            const code = document.getElementById('input-group-code').value.trim().toLowerCase();
            if(code !== state.groupCode) {
                state.groupCode = code;
                localStorage.setItem('regatta_group_code', code);
                setupListeners();
            }
        };

        document.getElementById('add-event-form').onsubmit = async (e) => {
            e.preventDefault();
            if(!state.user) return;
            const eventNum = document.getElementById('input-event-num').value;
            const alpha = document.getElementById('input-alpha').value;
            const crew = document.getElementById('input-crew').value;
            const time = document.getElementById('input-time').value;

            await addDoc(getEventsRef(), { 
                eventNum: eventNum || 'N/A', 
                alpha: alpha || '',
                crew, 
                originalTime: time 
            });
            e.target.reset();
        };

        window.deleteEvent = async (id) => {
            if(!state.user) return;
            await deleteDoc(doc(getEventsRef(), id));
        };

        const updateDelay = async (delta) => {
            if(!state.user) return;
            const newDelay = Math.max(0, state.delay + delta);
            await setDoc(getConfigRef(), { delay: newDelay, settings: state.settings }, { merge: true });
        };
        document.getElementById('btn-delay-plus').onclick = () => updateDelay(5);
        document.getElementById('btn-delay-minus').onclick = () => updateDelay(-5);

        document.getElementById('btn-toggle-config').onclick = () => els.configPanel.classList.toggle('hidden');

        const updateSettings = async () => {
            if(!state.user) return;
            const newSettings = {
                onWaterOffset: Number(document.getElementById('input-offset').value),
                warmUpDuration: Number(document.getElementById('input-warmup').value)
            };
            await setDoc(getConfigRef(), { delay: state.delay, settings: newSettings }, { merge: true });
        };
        document.getElementById('input-offset').onchange = updateSettings;
        document.getElementById('input-warmup').onchange = updateSettings;

        document.getElementById('btn-clear').onclick = async () => {
            if(!state.user || !confirm(`Delete all events for ${state.groupCode || 'myself'}?`)) return;
            const batch = writeBatch(db);
            state.events.forEach(ev => batch.delete(doc(getEventsRef(), ev.id)));
            batch.set(getConfigRef(), { delay: 0, settings: state.settings });
            await batch.commit();
        };

        document.getElementById('input-csv').onchange = (e) => {
            const file = e.target.files[0];
            if(!file || !state.user) return;
            const reader = new FileReader();
            reader.onload = async (evt) => {
                const lines = evt.target.result.split('\n');
                const batch = writeBatch(db);
                const colRef = getEventsRef();
                let count = 0;
                lines.forEach((line, idx) => {
                    if(!line.trim()) return;
                    const cols = line.split(',').map(c => c.trim());
                    if((cols[0].toLowerCase().includes('event') || cols[0].toLowerCase().includes('number')) && idx === 0) return;
                    
                    let eventNum='', alpha='', crew='', time='';
                    if(cols.length >= 4) { eventNum=cols[0]; alpha=cols[1]; crew=cols[2]; time=cols[3]; }
                    else if(cols.length === 3) { eventNum=cols[0]; crew=cols[1]; time=cols[2]; }
                    else if(cols.length === 2) { crew=cols[0]; time=cols[1]; }

                    if(time && time.match(/\d{1,2}:\d{2}/)) {
                        batch.set(doc(colRef), { eventNum, alpha, crew, originalTime: time });
                        count++;
                    }
                });
                if(count > 0) await batch.commit();
                else alert("No valid rows found. Check format: Event, Alpha, Crew, Time (HH:MM)");
            };
            reader.readAsText(file);
            e.target.value = null;
        };

        document.getElementById('btn-template').onclick = () => {
            const csvContent = "Event Number,Alpha,Crew Name,Start Time (HH:MM)\n101,A,Sample Crew A,08:30\n101,B,Sample Crew B,08:35";
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "regatta_template.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        document.getElementById('btn-demo').onclick = async () => {
            if(!state.user) return;
            const demo = [
                { eventNum: '101', alpha: 'A', crew: 'M U19 8+', originalTime: '08:00' },
                { eventNum: '101', alpha: 'B', crew: 'M U19 8+', originalTime: '08:05' },
                { eventNum: '102', alpha: '', crew: 'W Club 4x', originalTime: '08:15' },
                { eventNum: '105', alpha: 'A', crew: 'M Novice 2-', originalTime: '08:30' }
            ];
            const batch = writeBatch(db);
            const colRef = getEventsRef();
            demo.forEach(d => batch.set(doc(colRef), d));
            await batch.commit();
        };

        setInterval(() => { state.currentTime = new Date(); render(); }, 1000);
        lucide.createIcons();
    </script>
</body>
</html>
